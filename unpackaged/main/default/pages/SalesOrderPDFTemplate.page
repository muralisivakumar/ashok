<apex:page controller="SalesOrderPDFController" applyBodyTag="false" showHeader="false" sidebar="false" renderAs="pdf">
    <head>
        <style>
            /* Basic page setup */
            @page {
                size: {!pageOrientation};
                margin: 0.5in 0.5in 1.5in 0.5in; /* Increased bottom margin for footer */
                counter-increment: page; /* Changed from "pages" to "page" */
                @bottom-center {
                    content: element(footer);
                }
            }
            
            body {
                font-family: Arial, sans-serif;
                font-size: 12px;
                color: #333333;
                margin: 0;
                padding: 0;
            }

            p {
                margin: 0px;
                padding: 0px;
            }
            
            /* Layout styles */
            .row {
                float: left;
                width: 100%;
                margin-bottom: 12px;
                clear: both;
            }
            
            .col {
                width: 48%;
            }
            
            .left {
                float: left;
            }
            
            .right {
                float: right;
            }
            
            /* Header styles */
            #header {
                font-size: 12px;
                font-weight: bold;
                margin-bottom: 20px;
            }
            
            /* Info box styling */
            .info-box {
                border: 1px solid #ccc;
                background-color: #f5f5f5;
                padding: 5px 8px 8px;
                margin-bottom: 5px; /* Reduced from 15px to 8px */
                height: 140px; /* Fixed height for all address boxes */
                overflow: auto; /* Add scrolling if content exceeds height */
            }
            
            .info-box h3 {
                margin: 0 0 2px 0;
                padding: 0 0 2px 0;
                border-bottom: 1px solid #ddd;
                font-size: 14px;
            }
            
            /* salesorder info table */
            .salesorder-info {
                width: 100%;
                border-collapse: collapse;
                margin-bottom: 7px;
            }
            
            .salesorder-info td {
                padding: 3px;
                border: 1px solid #ccc;
                text-align: center; /* Center align all cells */
            }
            
            .salesorder-info td.label {
                font-weight: bold;
                background-color: #f5f5f5;
                width: 40%;
            }
            
            /* Order info table */
            .order-info-table {
                width: 100%;
                border-collapse: collapse;
                margin-bottom: 5px;
                font-size: 11px;
            }
            
            .order-info-table th {
                background-color: #8DAEC1;
                color: white;
                text-align: left;
                padding: 5px 8px;
                border: 1px solid #ccc;
            }
            
            .order-info-table td {
                padding: 5px 8px;
                border: 1px solid #ccc;
            }
            
            /* Line items table styling */
            .table {
                width: 100%;
                border-collapse: collapse;
                font-size: 11px;
            }
            
            .table th {
                background-color: #8DAEC1;
                color: white;
                font-weight: bold;
                padding: 6px;
                border: 1px solid #ccc;
                text-align: left;
            }
            
            .table td {
                padding: 6px;
                border: 1px solid #ccc;
                vertical-align: top;
            }
             .table td {
                padding: 6px;
                border: 1px solid #ccc;
                vertical-align: top;
                /* Add word wrapping for most columns */
                word-wrap: break-word;
                word-break: break-word;
               
            }
            
            .table tr:nth-child(even) {
                background-color: #f9f9f9;
            }
            
            /* Group header and subtotal */
            .group-header {
                background-color: #8DAEC1;
                color: white;
                font-weight: bold;
                font-size: 12px;
                text-align: left;
                padding: 8px;
                border: 1px solid #ccc;
                border-bottom: none;
            }
            
            .group-subtotal {
                background-color: #f3f3f3;
                font-weight: bold;
            }
            
            /* Totals section - Updated with page-break-inside: avoid */
            .totals-section {
                width: 100%;
                page-break-inside: avoid;
            }
            
            .totals-table {
                width: 350px;
                float: right;
                border-collapse: collapse;
                page-break-inside: avoid;
            }
            .totals-table tr {
                margin-top: 20px;
                padding: 10px;
            }
            
            .totals-table td {
                 font-size: 11px;
            }
            
            .total-label {
                text-align: right;
            }
            
            .total-value {
                text-align: right;
                width: 120px;
            }
            
            td.grand-total {
                font-weight: bold;
                border-top: 1px solid #000;
            }

            
            /* Footer styling - updated */
            .footer {
                position: running(footer);
                width: 100%;
                font-size: 9px;
                color: #666;
                padding-top: 8px;
                border-top: 1px solid #ddd;
                border: 1px solid transparent;
            }

            .footer-content {
                width: 100%;
            }

            .footer-disclaimer {
                width: 100%;
                margin-bottom: 10px;
            }

            .footer-row {
                width: 100%;
                display: table;
                table-layout: fixed;
            }

            .footer-left {
                display: table-cell;
                text-align: left;
                width: 70%;
            }

            .footer-right {
                display: table-cell;
                text-align: right;
                width: 30%;
            }
            
            /* Fixed page number display */
            #pageNum:after {
                content: counter(page);
            }
        </style>
    </head>
    <body>
        <!-- Header Section -->
        <div id="header" class="section">
            <div class="row">
                <div class="col left">
                    <apex:outputPanel rendered="{!account.RecordType.Name == 'Canadian Account'}">
                        <apex:image id="logoCA" value="{!$Resource.LogoCA}" width="200"/>   
                    </apex:outputPanel>
                    <apex:outputPanel rendered="{!account.RecordType.Name == 'US Account'}">
                        <apex:image id="logoUS" value="{!$Resource.LogoUS}" width="225"/>   
                    </apex:outputPanel>
                </div>
                <div class="col right" style="text-align: right;">
                    <div style="font-size:20pt; font-weight:bold; margin-bottom:10px;">Sales Order</div>
                </div>
            </div>
            
            <div class="row">
                <div class="col left">
                    <p>
                        <strong>{!companyInfo.name}</strong><br/>
                        {!companyInfo.street}<br/>
                        {!companyInfo.suite}<br/>
                        {!companyInfo.cityStateZip}<br/>
                        Phone: {!companyInfo.phone}<br/>
                        <a href="{!companyInfo.website}">{!companyInfo.website}</a>
                    </p>
                </div>
                <div class="col right">
                    <table class="salesorder-info">
                        <tr>
                            <td class="label">Order #</td>
                            <td>{!salesOrder.varcpq__SO_Number__c}</td>
                        </tr>
                        <tr>
                            <td class="label">Terms</td>
                            <td>{!salesOrder.SO_Net_Terms__c}</td>
                        </tr>
                        <tr>
                            <td class="label">Contact</td>
                            <td>{!salesOrder.Billing_Contact_Name__c}</td>
                        </tr>
                        <tr>
                            <td class="label">Order Date:</td>
                            <td>
                                <apex:outputText value="{0, date, MMMM d','  yyyy}">
                                    <apex:param value="{!salesOrder.Order_Date__c}" />
                                </apex:outputText>
                            </td>
                        </tr>
                    </table>
                    
                    <p style="margin-top:5px; text-align:right;">
                        <strong>Sales Rep:</strong> {!account.Owner.Name}<br/>
                        <a href="mailto:{!account.Owner.Email}">{!account.Owner.Email}</a>
                    </p>
                </div>
            </div>
        </div>
        
        <!-- Address Section -->
        <div class="section">
            <div class="row">
                <div class="col left" style="width:32%;">
                    <div class="info-box">
                        <h3>Customer</h3>
                        <p>
                            {!salesOrder.Billing_Company__c}<br/>
                            {!salesOrder.Billing_Contact_Name__c}<br/>
                            {!salesOrder.varcpq__Billing_Street__c}<br/>
                            <apex:outputPanel rendered="{!NOT(ISBLANK(salesOrder.Billing_Additional_Street__c))}">
                                {!salesOrder.Billing_Additional_Street__c}<br/>
                            </apex:outputPanel>
                            {!salesOrder.varcpq__Billing_City__c}, {!salesOrder.varcpq__Billing_State__c} {!salesOrder.varcpq__Billing_Zip__c}<br/>
                            {!salesOrder.Billing_Phone__c}<br/>
                            <apex:outputText value="{!salesOrder.Billing_Email__c}" rendered="{!NOT(ISBLANK(salesOrder.Billing_Email__c))}" />
                        </p>
                    </div>
                </div>
                <div class="col left" style="width:32%; margin-left:2%;">
                    <div class="info-box">
                        <h3>Bill To</h3>
                        <p>
                            {!salesOrder.Billing_Company__c}<br/>
                            {!salesOrder.Billing_Contact_Name__c}<br/>
                            {!salesOrder.varcpq__Billing_Street__c}<br/>
                            <apex:outputPanel rendered="{!NOT(ISBLANK(salesOrder.Billing_Additional_Street__c))}">
                                {!salesOrder.Billing_Additional_Street__c}<br/>
                            </apex:outputPanel>
                            {!salesOrder.varcpq__Billing_City__c}, {!salesOrder.varcpq__Billing_State__c} {!salesOrder.varcpq__Billing_Zip__c}<br/>
                            {!salesOrder.Billing_Phone__c}<br/>
                            <apex:outputText value="{!salesOrder.Billing_Email__c}" rendered="{!NOT(ISBLANK(salesOrder.Billing_Email__c))}" />
                        </p>
                    </div>
                </div>
                <div class="col right" style="width:32%;">
                    <div class="info-box">
                        <h3>Ship To</h3>
                        <p>
                            {!salesOrder.Shipping_Company__c}<br/>
                            <apex:outputPanel rendered="{!NOT(ISBLANK(salesOrder.Additional_Ship_To_Header__c))}">
                                {!salesOrder.Additional_Ship_To_Header__c}<br/>
                            </apex:outputPanel>
                            Attn:{!salesOrder.Shipping_Contact_Name__c}<br/>
                            {!salesOrder.varcpq__Shipping_Street__c}<br/>
                            <apex:outputPanel rendered="{!NOT(ISBLANK(salesOrder.Shipping_Additional_Street__c))}">
                                {!salesOrder.Shipping_Additional_Street__c}<br/>
                            </apex:outputPanel>
                            {!salesOrder.varcpq__Shipping_City__c}, {!salesOrder.varcpq__Shipping_State__c} {!salesOrder.varcpq__Shipping_Zip__c}<br/>
                            {!salesOrder.Shipping_Phone__c}<br/>
                            <apex:outputText value="{!salesOrder.Shipping_Email__c}" rendered="{!NOT(ISBLANK(salesOrder.Shipping_Email__c))}" />
                        </p>
                    </div>
                </div>
            </div>
            
            <!-- Order Info Row -->
            <div class="row">
                <table class="order-info-table">
                    <tr>
                        <th>Description</th>
                        <th>Customer PO</th>
                        <th>Contract</th>
                        <th>Ship Via</th>
                        <th>Cost Centre Reference</th>
                    </tr>
                    <tr>
                        <td>
                            <apex:outputText value="{!salesOrder.Name}" rendered="{!NOT(ISBLANK(salesOrder.Name))}" />
                        </td>
                        <td>
                            <apex:outputText value="{!salesOrder.varcpq__Customer_PO__c}" rendered="{!NOT(ISBLANK(salesOrder.varcpq__Customer_PO__c))}" />
                        </td>
                        <td>
                           <apex:outputText value="{!salesOrder.Contract__r.Name}" rendered="{!NOT(ISBLANK(salesOrder.Contract__r.Name))}" />
                        </td>
                        <td>
                            <apex:outputText value="{!salesOrder.Shipping_Method__c}" rendered="{!NOT(ISBLANK(salesOrder.Shipping_Method__c))}" />
                        </td>
                         <td>
                            <apex:outputText value="{!salesOrder.Cost_Centre_Reference__c}" rendered="{!NOT(ISBLANK(salesOrder.Cost_Centre_Reference__c))}" />
                        </td>
                    </tr>
                </table>
            </div>

            <!-- Line Items Table -->
            <div class="row">
                <!-- Groups Display -->
                <apex:outputPanel rendered="{!hasMultipleGroups}">
                    <apex:repeat value="{!salesOrderGroups}" var="salesOrderGroup">
                        <div class="group-header">{!salesOrderGroup.groupRecord.Name}</div>
                        <table class="table">
                            <thead>
                                <tr>
                                    <th style="width:4%;text-align:center;">#</th>
                                    <th style="width:15%;">Mfg</th>
                                    <th style="width:10%;">Mfg Part #</th>
                                    <th style="width:5%;text-align:center;">Qty</th>
                                    <th>Description</th>
                                    <th style="width:13%;text-align:right;">Price</th>
                                    <th style="width:13%;text-align:right;">Extended Price</th>
                                </tr>
                            </thead>
                            <tbody>
                                <apex:repeat value="{!salesOrderGroup.lineItems}" var="line">
                                    <tr>
                                        <td style="text-align:center;">
                                            <apex:outputText value="{0, number, 0}">
                                                <apex:param value="{!line.varcpq__Line__c}" />
                                            </apex:outputText>
                                        </td>
                                        <td>{!line.varcpq__Product__r.varcpq__Manufacturer__r.Name}</td>
                                        <td>{!line.varcpq__Product__r.Name}</td>
                                        <td style="text-align:center;">
                                            <apex:outputText value="{0, number, 0}">
                                                <apex:param value="{!line.varcpq__Quantity__c}" />
                                            </apex:outputText>
                                        </td>
                                  
                                            
                                        
                                         <!--   <td style="width:130px;word-wrap:break-word;word-break:break-word;">
                                            <apex:outputText value="{!
                                                                    IF(LEN(line.varcpq__Description__c) > 40,
                                                                    LEFT(line.varcpq__Description__c, 20) + '<br/>' +
                                                                    IF(LEN(line.varcpq__Description__c) > 40,
                                                                    MID(line.varcpq__Description__c, 21, 20) + '<br/>' +
                                                                    IF(LEN(line.varcpq__Description__c) > 60,
                                                                    MID(line.varcpq__Description__c, 41, 20) + '<br/>' +
                                                                    IF(LEN(line.varcpq__Description__c) > 80,
                                                                    MID(line.varcpq__Description__c, 61, 20) + '<br/>' +
                                                                    MID(line.varcpq__Description__c, 81, 20),
                                                                    MID(line.varcpq__Description__c, 61, 40)
                                                                    ),
                                                                    MID(line.varcpq__Description__c, 41, 60)
                                                                    ),
                                                                    MID(line.varcpq__Description__c, 21, 80)
                                                                    ),
                                                                    line.varcpq__Description__c
                                                                    )
                                                                    }" escape="false"/>
                                        </td>-->
  <!-- Updated by Vishnu on 07/11/2025 for "P6 - Customer Notes Formatting Lost When Generating PDF" -->
  <!--<td style="width:130px; word-wrap: break-word; word-break: break-word;">
    <apex:repeat value="{!lineItemDescriptionChunks[line.Id]}" var="lineChunk">
      <div>{!lineChunk}</div>
    </apex:repeat>
  </td>-->
  <td style="width:130px;">
    <apex:outputText value="{!lineItemDescriptionChunks[line.Id]}" escape="false" />
</td>
  


                                        <td style="text-align:right;">
                                            <apex:outputText rendered="{!salesOrder.CurrencyIsoCode == 'USD'}" value="${0, number, .00}">
                                                <apex:param value="{!line.varcpq__Unit_Price__c}" />
                                            </apex:outputText>
                                            <apex:outputText rendered="{!salesOrder.CurrencyIsoCode == 'CAD'}" value="CAD ${0, number, .00}">
                                                <apex:param value="{!line.varcpq__Unit_Price__c}" />
                                            </apex:outputText>
                                        </td>
                                        <td style="text-align:right;">
                                            <apex:outputText rendered="{!salesOrder.CurrencyIsoCode == 'USD'}" value="${0, number, .00}">
                                                <apex:param value="{!line.varcpq__Total_Ext_Price__c}" />
                                            </apex:outputText>
                                            <apex:outputText rendered="{!salesOrder.CurrencyIsoCode == 'CAD'}" value="CAD ${0, number, .00}">
                                                <apex:param value="{!line.varcpq__Total_Ext_Price__c}" />
                                            </apex:outputText>
                                        </td>
                                    </tr>
                                </apex:repeat>
                                <tr class="group-subtotal">
                                    <td colspan="6" style="text-align:right;">{!salesOrderGroup.groupRecord.Name} Subtotal:</td>
                                    <td style="text-align:right;">
                                        <apex:outputText rendered="{!salesOrder.CurrencyIsoCode == 'USD'}" value="${0, number, .00}">
                                            <apex:param value="{!IF(salesOrderGroup.groupRecord.Sub_Total__c != null, salesOrderGroup.groupRecord.Sub_Total__c, salesOrderGroup.subtotal)}" />
                                        </apex:outputText>
                                        <apex:outputText rendered="{!salesOrder.CurrencyIsoCode == 'CAD'}" value="CAD ${0, number, .00}">
                                            <apex:param value="{!IF(salesOrderGroup.groupRecord.Sub_Total__c != null, salesOrderGroup.groupRecord.Sub_Total__c, salesOrderGroup.subtotal)}" />
                                        </apex:outputText>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                        <div style="height:15px;"></div>
                    </apex:repeat>
                            
                    <!-- Ungrouped Items -->
                    <apex:outputPanel rendered="{!ungroupedItems.size > 0}">
                        <div class="group-header">Other Items</div>
                        <table class="table">
                            <thead>
                                <tr>
                                    <th style="width:4%;text-align:center;">#</th>
                                    <th style="width:15%;">Mfg</th>
                                    <th style="width:10%;">Mfg Part #</th>
                                    <th style="width:5%;text-align:center;">Qty</th>
                                    <!-- Surya -- Commenting below table heading and adding another -->
                                   <!-- <th>varcpq__Description__c</th>-->
                                    <th>Description</th>
                                    <th style="width:13%;text-align:right;">Price</th>
                                    <th style="width:13%;text-align:right;">Extended Price</th>
                                </tr>
                            </thead>
                            <tbody>
                                <apex:repeat value="{!ungroupedItems}" var="line">
                                    <tr>
                                        <td style="text-align:center;">
                                            <apex:outputText value="{0, number, 0}">
                                                <apex:param value="{!line.varcpq__Line__c}" />
                                            </apex:outputText>
                                        </td>
                                        <td>{!line.varcpq__Product__r.varcpq__Manufacturer__r.Name}</td>
                                        <td>{!line.varcpq__Product__r.Name}</td>
                                        <td style="text-align:center;">
                                            <apex:outputText value="{0, number, 0}">
                                                <apex:param value="{!line.varcpq__Quantity__c}" />
                                            </apex:outputText>
                                        </td>
                                  
                                             
										
                                      <!--   <td style="width:130px;word-wrap:break-word;word-break:break-word;">
                                            <apex:outputText value="{!
                                                                    IF(LEN(line.varcpq__Description__c) > 40,
                                                                    LEFT(line.varcpq__Description__c, 20) + '<br/>' +
                                                                    IF(LEN(line.varcpq__Description__c) > 40,
                                                                    MID(line.varcpq__Description__c, 21, 20) + '<br/>' +
                                                                    IF(LEN(line.varcpq__Description__c) > 60,
                                                                    MID(line.varcpq__Description__c, 41, 20) + '<br/>' +
                                                                    IF(LEN(line.varcpq__Description__c) > 80,
                                                                    MID(line.varcpq__Description__c, 61, 20) + '<br/>' +
                                                                    MID(line.varcpq__Description__c, 81, 20),
                                                                    MID(line.varcpq__Description__c, 61, 40)
                                                                    ),
                                                                    MID(line.varcpq__Description__c, 41, 60)
                                                                    ),
                                                                    MID(line.varcpq__Description__c, 21, 80)
                                                                    ),
                                                                    line.varcpq__Description__c
                                                                    )
                                                                    }" escape="false"/>
                                        </td>-->
  <!-- Updated by Vishnu on 07/11/2025 for "P6 - Customer Notes Formatting Lost When Generating PDF" -->
  <!--<td style="width:130px; word-wrap: break-word; word-break: break-word;">
    <apex:repeat value="{!lineItemDescriptionChunks[line.Id]}" var="lineChunk">
      <div>{!lineChunk}</div>
    </apex:repeat>
  </td>-->
  <td style="width:130px;">
   <apex:outputText value="{!lineItemDescriptionChunks[line.Id]}" escape="false" />
</td>


                                                       
                                        <td style="text-align:right;">
                                            <apex:outputText rendered="{!salesOrder.CurrencyIsoCode == 'USD'}" value="${0, number, .00}">
                                                <apex:param value="{!line.varcpq__Unit_Price__c}" />
                                            </apex:outputText>
                                            <apex:outputText rendered="{!salesOrder.CurrencyIsoCode == 'CAD'}" value="CAD ${0, number, .00}">
                                                <apex:param value="{!line.varcpq__Unit_Price__c}" />
                                            </apex:outputText>
                                        </td>
                                        <td style="text-align:right;">
                                            <apex:outputText rendered="{!salesOrder.CurrencyIsoCode == 'USD'}" value="${0, number, .00}">
                                                <apex:param value="{!line.varcpq__Total_Ext_Price__c}" />
                                            </apex:outputText>
                                            <apex:outputText rendered="{!salesOrder.CurrencyIsoCode == 'CAD'}" value="CAD ${0, number, .00}">
                                                <apex:param value="{!line.varcpq__Total_Ext_Price__c}" />
                                            </apex:outputText>
                                        </td>
                                    </tr>
                                </apex:repeat>
                            </tbody>
                        </table>
                    </apex:outputPanel>
                </apex:outputPanel>
                        
                <!-- Default table (no groups) -->
                <apex:outputPanel rendered="{!NOT(hasMultipleGroups)}">
                    <table class="table">
                        <thead>
                            <tr>
                                <th style="width:4%;text-align:center;">#</th>
                                <th style="width:15%;">Mfg</th>
                                <th style="width:10%;">Mfg Part #</th>
                                <th style="width:5%;text-align:center;">Qty</th>
                                <th>Description</th>
                                <th style="width:13%;text-align:right;">Price</th>
                                <th style="width:13%;text-align:right;">Extended Price</th>
                            </tr>
                        </thead>
                        <tbody>
                            <apex:repeat value="{!ungroupedItems}" var="line">
                                <tr>
                                    <td style="text-align:center;">
                                        <apex:outputText value="{0, number, 0}">
                                            <apex:param value="{!line.varcpq__Line__c}" />
                                        </apex:outputText>
                                    </td>
                                    <td>{!line.varcpq__Product__r.varcpq__Manufacturer__r.Name}</td>
                                    <td>{!line.varcpq__Product__r.Name}</td>
                                    <td style="text-align:center;">
                                        <apex:outputText value="{0, number, 0}">
                                            <apex:param value="{!line.varcpq__Quantity__c}" />
                                        </apex:outputText>
                                    </td>
                                 
                                          
                                   <!--   <td style="width:130px;word-wrap:break-word;word-break:break-word;">
                                            <apex:outputText value="{!
                                                                    IF(LEN(line.varcpq__Description__c) > 40,
                                                                    LEFT(line.varcpq__Description__c, 20) + '<br/>' +
                                                                    IF(LEN(line.varcpq__Description__c) > 40,
                                                                    MID(line.varcpq__Description__c, 21, 20) + '<br/>' +
                                                                    IF(LEN(line.varcpq__Description__c) > 60,
                                                                    MID(line.varcpq__Description__c, 41, 20) + '<br/>' +
                                                                    IF(LEN(line.varcpq__Description__c) > 80,
                                                                    MID(line.varcpq__Description__c, 61, 20) + '<br/>' +
                                                                    MID(line.varcpq__Description__c, 81, 20),
                                                                    MID(line.varcpq__Description__c, 61, 40)
                                                                    ),
                                                                    MID(line.varcpq__Description__c, 41, 60)
                                                                    ),
                                                                    MID(line.varcpq__Description__c, 21, 80)
                                                                    ),
                                                                    line.varcpq__Description__c
                                                                    )
                                                                    }" escape="false"/>
</td>-->                     
  <!-- Updated by Vishnu on 07/11/2025 for "P6 - Customer Notes Formatting Lost When Generating PDF" -->
  <!--<td style="width:130px; word-wrap: break-word; word-break: break-word;">
    <apex:repeat value="{!lineItemDescriptionChunks[line.Id]}" var="lineChunk">
      <div>{!lineChunk}</div>
    </apex:repeat>
  </td>-->
 <td style="width:130px;">
    <apex:outputText value="{!lineItemDescriptionChunks[line.Id]}" escape="false" />
</td>

                                    
                                    <td style="text-align:right;">
                                        <apex:outputText rendered="{!salesOrder.CurrencyIsoCode == 'USD'}" value="${0, number, .00}">
                                            <apex:param value="{!line.varcpq__Unit_Price__c}" />
                                        </apex:outputText>
                                        <apex:outputText rendered="{!salesOrder.CurrencyIsoCode == 'CAD'}" value="CAD ${0, number, .00}">
                                            <apex:param value="{!line.varcpq__Unit_Price__c}" />
                                        </apex:outputText>
                                    </td>
                                    <td style="text-align:right;">
                                        <apex:outputText rendered="{!salesOrder.CurrencyIsoCode == 'USD'}" value="${0, number, .00}">
                                            <apex:param value="{!line.varcpq__Total_Ext_Price__c}" />
                                        </apex:outputText>
                                        <apex:outputText rendered="{!salesOrder.CurrencyIsoCode == 'CAD'}" value="CAD ${0, number, .00}">
                                            <apex:param value="{!line.varcpq__Total_Ext_Price__c}" />
                                        </apex:outputText>
                                    </td>
                                </tr>
                            </apex:repeat>
                        </tbody>
                    </table>
                </apex:outputPanel>
            </div>
            
            <!-- Totals Section - Wrapped in a div with page-break-inside: avoid -->
            <div class="totals-section">
                <table class="totals-table">
                    <tr>
                        <td class="total-label">Sub Total:</td>
                        <td class="total-value">
                            <apex:outputText rendered="{!salesOrder.CurrencyIsoCode == 'USD'}" value="{0, number, Currency}">
                                <apex:param value="{!salesOrder.Sub_Total__c}" />
                            </apex:outputText>
                            <apex:outputText rendered="{!salesOrder.CurrencyIsoCode == 'CAD'}" value="CAD {0, number, Currency}">
                                <apex:param value="{!salesOrder.Sub_Total__c}" /> 
                            </apex:outputText>
                        </td>
                    </tr>
                    <!-- GST -->
                    <apex:outputPanel layout="none" rendered="{!AND(salesOrder.CurrencyIsoCode == 'CAD', salesOrder.Tax_Amount_GST__c > 0)}">
                        <tr>
                            <td class="total-label">
                                <apex:outputText rendered="{!salesOrder.Tax_Amount_GST__c > 0}" value="GST ({0, number, 0.00}%):">
                                    <apex:param value="{!salesOrder.Tax_Rate_GST__c}"/>
                                </apex:outputText>
                            </td>
                            <td class="total-value">
                                <apex:outputText rendered="{!salesOrder.Tax_Amount_GST__c > 0}" value="CAD {0, Number, Currency}">
                                    <apex:param value="{!salesOrder.Tax_Amount_GST__c}" />
                                </apex:outputText>
                            </td>
                        </tr>
                    </apex:outputPanel>
                    <!-- PST -->
                    <apex:outputPanel layout="none" rendered="{!AND(salesOrder.CurrencyIsoCode == 'CAD', salesOrder.Tax_Amount_PST__c > 0)}">
                        <tr>
                            <td class="total-label">
                                <apex:outputText rendered="{!salesOrder.Tax_Amount_PST__c > 0}" value="PST ({0, number, 0.00}%):">
                                    <apex:param value="{!salesOrder.Tax_Rate_PST__c}"/>
                                </apex:outputText>
                            </td>
                            <td class="total-value">
                                <apex:outputText rendered="{!salesOrder.Tax_Amount_PST__c > 0}" value="CAD {0, Number, Currency}">
                                    <apex:param value="{!salesOrder.Tax_Amount_PST__c}" />
                                </apex:outputText>
                            </td>
                        </tr>
                    </apex:outputPanel>
                    <!-- HST -->
                    <apex:outputPanel layout="none" rendered="{!AND(salesOrder.CurrencyIsoCode == 'CAD', salesOrder.Tax_Amount_HST__c > 0)}">
                        <tr>
                            <td class="total-label">
                                <apex:outputText rendered="{!salesOrder.Tax_Amount_HST__c > 0}" value="HST ({0, number, 0.00}%):">
                                    <apex:param value="{!salesOrder.Tax_Rate_HST__c}"/>
                                </apex:outputText>
                            </td>
                            <td class="total-value">
                                <apex:outputText rendered="{!salesOrder.Tax_Amount_HST__c > 0}" value="CAD {0, Number, Currency}">
                                    <apex:param value="{!salesOrder.Tax_Amount_HST__c}" />
                                </apex:outputText>
                            </td>
                        </tr>
                    </apex:outputPanel>
                    <!-- QST -->
                    <apex:outputPanel layout="none" rendered="{!AND(salesOrder.CurrencyIsoCode == 'CAD', salesOrder.Tax_Amount_QST__c > 0)}">
                        <tr>
                            <td class="total-label">
                                <apex:outputText rendered="{!salesOrder.Tax_Amount_QST__c > 0}" value="QST ({0, number, 0.00}%):">
                                    <apex:param value="{!salesOrder.Tax_Rate_QST__c}"/>
                                </apex:outputText>
                            </td>
                            <td class="total-value">
                                <apex:outputText rendered="{!salesOrder.Tax_Amount_QST__c > 0}" value="CAD {0, Number, Currency}">
                                    <apex:param value="{!salesOrder.Tax_Amount_QST__c}" />
                                </apex:outputText>
                            </td>
                        </tr>
                    </apex:outputPanel>
                    <apex:outputPanel layout="none" rendered="{!AND(NOT(ISBLANK(salesOrder.Taxes__c)), salesOrder.Taxes__c != 0 )}">
                        <tr>
                            <td class="total-label">
                                <apex:outputText rendered="{!AND(salesOrder.CurrencyIsoCode == 'USD', salesOrder.Taxes__c > 0)}" value="Tax ({0, number,0.000'%'}):">
                                    <apex:param value="{!salesOrder.tax_rate1__c}" />
                                </apex:outputText>
                            </td>
                            <td class="total-value">
                                <apex:outputText rendered="{!AND(salesOrder.CurrencyIsoCode == 'USD', salesOrder.Taxes__c > 0)}" value="{0, number, Currency}">
                                    <apex:param value="{!salesOrder.Taxes__c}" />
                                </apex:outputText>
                            </td>
                        </tr>
                    </apex:outputPanel>
                    <apex:outputPanel layout="none" rendered="{!AND(NOT(ISBLANK(salesOrder.varcpq__Shipping_and_Handling__c)), salesOrder.varcpq__Shipping_and_Handling__c != 0)}">
                        <tr> 
                            <td class="total-label">Shipping and Handling:</td>
                            <td class="total-value">
                                <apex:outputText rendered="{!salesOrder.CurrencyIsoCode == 'USD'}" value="{0, number, Currency}">
                                    <apex:param value="{!salesOrder.varcpq__Shipping_and_Handling__c}" />
                                </apex:outputText>
                                <apex:outputText rendered="{!salesOrder.CurrencyIsoCode == 'CAD'}" value="CAD {0, number, Currency}">
                                    <apex:param value="{!salesOrder.varcpq__Shipping_and_Handling__c}" />
                                </apex:outputText> 
                            </td>
                        </tr>
                    </apex:outputPanel>
                    <apex:outputPanel layout="none" rendered="{!AND(AND(NOT(ISBLANK(salesOrder.Shipping_and_Handling_Tax__c)), salesOrder.Shipping_and_Handling_Tax__c != 0),salesOrder.CurrencyIsoCode == 'CAD')}">
                        <tr> 
                            <td class="total-label">Shipping and Handling Tax:</td>
                            <td class="total-value">
                                <apex:outputText rendered="{!salesOrder.CurrencyIsoCode == 'USD'}" value="{0, number, Currency}">
                                    <apex:param value="{!salesOrder.Shipping_and_Handling_Tax__c}" />
                                </apex:outputText>
                                <apex:outputText rendered="{!salesOrder.CurrencyIsoCode == 'CAD'}" value="CAD {0, number, Currency}">
                                    <apex:param value="{!salesOrder.Shipping_and_Handling_Tax__c}" />
                                </apex:outputText> 
                            </td>
                        </tr>
                    </apex:outputPanel>
                    <tr>
                        <td class="total-label grand-total">Total:</td>
                        <td class="total-value grand-total">
                            <apex:outputText rendered="{!salesOrder.CurrencyIsoCode == 'USD'}" value="{0, number, Currency}">
                                <apex:param value="{!salesOrder.Grand_Total__c}" />
                            </apex:outputText>
                            <apex:outputText rendered="{!salesOrder.CurrencyIsoCode == 'CAD'}" value="CAD {0, number, Currency}">
                                <apex:param value="{!salesOrder.Grand_Total__c}" />
                            </apex:outputText>
                        </td>
                    </tr>
                </table>
            </div>
        </div>

        <!--Render Customer Notes If Present
        <apex:outputPanel rendered="{!NOT(ISBLANK(salesOrder.varcpq__Notes__c))}">
            <div class="section">
                <div class="row" style="margin-top:20px;">
                    <b>Notes: </b> {!salesOrder.varcpq__Notes__c}
                </div>
            </div>
        </apex:outputPanel>-->
        
         <apex:outputPanel rendered="{!NOT(ISNULL(customerNotes)) && customerNotes.size > 0}">
            <div class="section" style="margin-top:20px;">
               
                <apex:repeat value="{!customerNotes}" var="note">
                    <div class="row" style="margin-top:10px;">
                        <b>{!note.label}:</b><br/>
                        <apex:outputText value="{!note.text}" escape="false" />
                    </div>
                </apex:repeat>
            </div>
        </apex:outputPanel>



        
        <!-- THE FOOTER - This is moved to the running footer element through CSS -->
        <div class="footer">
            <div class="footer-content">
                <div class="footer-disclaimer">
                    <p>
                        <apex:outputText rendered="{!salesOrder.CurrencyIsoCode == 'CAD'}" value="Currency is CAD unless noted otherwise." />
                        <apex:outputText rendered="{!salesOrder.CurrencyIsoCode == 'USD'}" value="Currency is USD unless noted otherwise." />
                    </p>
                    <p>
                        If you are granted {!salesOrder.SO_Net_Terms__c} payment terms, you agree that if you are late paying your invoice, a 1.5%
                        finance charge or the maximum charge permitted by law may be assessed against all accounts with past due balances.
                        You agree to pay all the company's reasonable attorney's fees and all collection agency fees incurred in the collection of any
                        amount owed thereunder and not paid when due.
                    </p>
                </div>
                <div class="footer-row">
                    <div class="footer-left">
                        <apex:outputText rendered="{!salesOrder.CurrencyIsoCode == 'CAD'}">
                            GST/HST# 736342684 RT0001 // QST# 1226145814 TQ0002 // PST 7508781
                        </apex:outputText>
                    </div>
                    <div class="footer-right">
                        Sales Order #{!salesOrder.varcpq__SO_Number__c} &nbsp;&nbsp;&nbsp; Page <span id="pageNum"></span>
                    </div>
                </div>
            </div>
        </div>
    </body>
</apex:page>